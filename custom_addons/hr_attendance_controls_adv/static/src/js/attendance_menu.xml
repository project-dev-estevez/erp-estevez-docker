<?xml version="1.0" encoding="UTF-8"?>
<template>
    <t t-inherit="hr_attendance.attendance_menu" t-inherit-mode="extension">
        
        <!-- ğŸ¯ PASO 7: Personalizar botÃ³n del systray segÃºn attendance_status -->
        <xpath expr="//button[i[contains(@class, 'fa-circle')]]" position="replace">
            <button t-if="this.state.isReady"
                    type="button"
                    class="btn btn-sm o_attendance_systray_button o-dropdown dropdown-toggle dropdown"
                    aria-expanded="false">
                
                <!-- ğŸ”´ Pre-work: Sin registro - Ã­cono rojo X -->
                <i t-if="this.state.attendance_status === 'pre_work'" 
                   class="fa fa-times-circle text-danger me-1" style="margin-top: 1px;"/>
                
                <!-- ğŸŸ¡ In-work: En jornada - Ã­cono amarillo play -->
                <i t-if="this.state.attendance_status === 'in_work'" 
                   class="fa fa-play-circle text-warning me-1" style="margin-top: 1px;"/>
                
                <!-- ğŸŸ¢ Post-work: Completado - Ã­cono verde check -->
                <i t-if="this.state.attendance_status === 'post_work'" 
                   class="fa fa-check-circle text-success me-1" style="margin-top: 1px;"/>
                
                <!-- ğŸ”˜ Fallback: Estado desconocido - Ã­cono original -->
                <i t-if="!this.state.attendance_status" 
                   class="fa fa-circle-o me-1"/>
                
                Asistencia
            </button>

            <button t-if="!this.state.isReady"
                type="button"
                class="btn btn-sm o_attendance_systray_button o-dropdown dropdown-toggle dropdown"
                aria-expanded="false"
                disabled="true">
                <i class="fa fa-circle-o-notch fa-spin me-1"/>
                Cargando...
            </button>
        </xpath>
        
        <!-- ğŸ”§ AGREGAR EVENTO onOpened AL DROPDOWN -->
        <xpath expr="//Dropdown" position="attributes">
            <attribute name="onOpened.bind">onOpenedContent</attribute>
        </xpath>
        
        <!-- ğŸ”„ REEMPLAZAR COMPLETAMENTE EL CONTENIDO DEL SLOT -->
        <xpath expr="//t[@t-set-slot='content']" position="replace">
            <t t-set-slot="content">
                <!-- ğŸ”„ SPINNER DE CARGA -->
                <div t-if="this.state.show_check_inout_button === false" class="o_att_menu_container_spinner text-center">
                    <i class="fa fa-circle-o-notch fa-spin spinner"></i>
                </div>
                
                <!-- ğŸ¯ PASO 8: CONTENIDO BASADO EN ATTENDANCE_STATUS -->
                <div t-if="this.state.show_check_inout_button" class="o_att_menu_container d-flex flex-column gap-3">
                    
                    <!-- ğŸŒ… VISTA PRE_WORK: Antes del primer check-in -->
                    <div t-if="this.state.attendance_status === 'pre_work'"
                         class="p-3 mb-3 rounded bg-light border">
                        <h5 class="mb-2 text-primary">
                            Â¡Bienvenido! ğŸ‘‹
                        </h5>
                        <p class="mb-3 text-muted">
                            TodavÃ­a no has iniciado tu jornada laboral.  
                            Pulsa el botÃ³n para iniciar tu <strong>jornada</strong> ğŸ˜‰
                        </p>


                        <button t-on-click="() => this.signInOut()"
                                class="btn btn-success w-100">
                            <i class="fa fa-sign-in me-2"/> 
                            Iniciar Jornada
                        </button>
                    </div>

                    <!-- ğŸŸ¡ VISTA IN_WORK: Jornada en curso -->
                    <div t-if="this.state.attendance_status === 'in_work'"
                         class="p-3 mb-3 rounded border border-warning">
                        <h5 class="mb-2 text-warning">
                            ğŸŸ¡ Jornada en curso
                        </h5>
                        <p class="mb-3 text-muted">
                            Â¡Ya has registrado tu entrada hoy! Tu jornada estÃ¡ activa.
                        </p>

                        <!-- ğŸ—ºï¸ INFORMACIÃ“N DE GEOCERCAS -->
                        <div t-if="this.state.geofences and this.state.geofences.length" class="mb-3 p-2 bg-light rounded text-center">
                            <small>ğŸ—ºï¸ Ubicaciones Permitidas:</small>
                            <ul class="list-unstyled">
                                <t t-foreach="this.state.geofences" t-as="geofence" t-key="geofence.id">
                                    <li class="fw-bold text-dark">
                                        <span t-esc="geofence.name"/>
                                        <span t-if="geofence.description" class="text-muted"> - <t t-esc="geofence.description"/></span>
                                    </li>
                                </t>
                            </ul>
                            <small t-if="this.state.ipaddress" class="text-muted">IP: <t t-esc="this.state.ipaddress"/> </small>
                        </div>

                        <button t-on-click="() => this.signInOut()"
                                class="btn btn-danger w-100">
                            <i class="fa fa-sign-out me-2"/> 
                            Finalizar Jornada
                        </button>
                    </div>

                    <!-- ğŸŸ¢ VISTA POST_WORK: Jornada completada -->
                    <div t-if="this.state.attendance_status === 'post_work'"
                         class="p-3 mb-3 rounded border border-success bg-light">
                        <h5 class="mb-2 text-success text-center">
                            ğŸ‰ Â¡Jornada Completada!
                        </h5>
                        <p class="mb-3 text-center text-muted">
                            Has completado exitosamente tu jornada laboral de hoy. <br/>
                            <strong>Â¡Excelente trabajo!</strong> ğŸ’ª
                        </p>

                        <!-- ğŸ’¬ MENSAJE MOTIVACIONAL -->
                        <div class="alert alert-success text-center mb-3">
                            <strong>Â¡Nos vemos!</strong><br/>
                            <small>Que tengas un excelente resto del dÃ­a ğŸ˜Š</small>
                        </div>

                        <!-- ğŸ”„ BOTÃ“N DE NUEVA JORNADA (opcional, para casos especiales) -->
                        <div class="text-center">
                            <small class="text-muted">
                                <i class="fa fa-info-circle me-1"/>
                                Si necesitas registrar una nueva entrada, contacta a tu supervisor
                            </small>
                        </div>
                    </div>
                    
                </div>
            </t>
        </xpath>
    </t>
</template>
<?xml version="1.0" encoding="UTF-8"?>
<template>
    <t t-inherit="hr_attendance.attendance_menu" t-inherit-mode="extension">
        <!-- 🔧 AGREGAR EVENTO onOpened AL DROPDOWN -->
        <xpath expr="//Dropdown" position="attributes">
            <attribute name="onOpened.bind">onOpenedContent</attribute>
        </xpath>
        
        <!-- 🔄 REEMPLAZAR COMPLETAMENTE EL CONTENIDO DEL SLOT -->
        <xpath expr="//t[@t-set-slot='content']" position="replace">
            <t t-set-slot="content">
                <!-- 🔄 SPINNER DE CARGA -->
                <div t-if="this.state.show_check_inout_button === false" class="o_att_menu_container_spinner text-center">
                    <i class="fa fa-circle-o-notch fa-spin spinner"></i>
                </div>
                
                <!-- 📋 CONTENIDO PRINCIPAL -->
                <div t-if="this.state.show_check_inout_button" class="o_att_menu_container d-flex flex-column gap-4">
                    <div class="d-flex flex-column gap-3">
                        <!-- 📊 INFORMACIÓN DE HORAS (cuando está checked in) -->
                        <div t-if="this.state.checkedIn" class="d-flex flex-wrap gap-3">
                            <div t-if="!this.isFirstAttendance" class="att_container flex-grow-1 flex-shrink-0">
                                <small class="d-block text-muted">Before <t t-esc="this.lastCheckIn"/></small>
                                <div t-esc="this.hoursPreviouslyToday" class="fs-3 text-info text-end"/>
                            </div>
                            <div class="att_container flex-grow-1 flex-shrink-0">
                                <small class="d-block text-muted">Since <t t-esc="this.lastCheckIn"/></small>
                                <div t-esc="this.lastAttendanceWorkedHours" t-attf-class="fs-3 text-info {{ !this.isFirstAttendance ? 'text-end' : '' }}"/>
                            </div>
                        </div>
                        
                        <!-- 📈 TOTAL HORAS HOY + BOTÓN PRINCIPAL -->
                        <div t-if="!this.isFirstAttendance"
                            class="att_container d-flex flex-column"
                            t-att-class="this.state.checkedIn ? 'p-3 bg-100 rounded' : ''">
                            <div class="d-flex" t-att-class="this.state.checkedIn ? 'align-items-center justify-content-between' : 'flex-column'">
                                <small class="text-muted">Total today</small>
                                <h2 t-esc="this.hoursToday" class="mb-0 fs-2"/>
                            </div>
                            <button t-on-click="() => this.signInOut()" class="flex-basis-100 mt-3" t-attf-class="btn btn-{{ this.state.checkedIn ? 'warning' : 'success' }}">
                                <span t-if="!this.state.checkedIn">Check in</span>
                                <span t-else="">Check out</span>
                                <i t-attf-class="fa fa-sign-{{ this.state.checkedIn ? 'out' : 'in' }} ms-1"/>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 🎯 BOTÓN PARA PRIMERA ASISTENCIA -->
                    <button t-if="this.isFirstAttendance" t-on-click="() => this.signInOut()" t-attf-class="btn btn-{{ this.state.checkedIn ? 'warning' : 'success' }}">
                        <span t-if="!this.state.checkedIn">Check in</span>
                        <span t-else="">Check out</span>
                        <i t-attf-class="fa fa-sign-{{ this.state.checkedIn ? 'out' : 'in' }} ms-1"/>
                    </button>

                    <!-- 🎛️ CONTROLES AVANZADOS -->
                    <div class="attendance_controls">
                        <!-- 📝 CONTROL DE MOTIVOS -->
                        <div t-attf-class="reason_container mb8 {{ this.state.show_reason ? '' : 'd-none' }}" id="reason_container" t-ref="reason_container">
                            <i t-attf-class="fa fa-1x fa-angle-double-down reason_toggle" id="reason_toggle" t-on-click="onToggleReason" t-ref="reason_toggle">
                                Reason
                            </i>
                            <div t-attf-class="reason_view d-none" t-ref="reason_view">
                                <input type="text" name="reasons" id="oe_attendance_reasons" list="reasons_list" class="o_input mt8 oe_attendance_reasons" 
                                    placeholder="Select / Enter your Reason here." autocomplete="off" t-ref="reasons_inut"/>
                                <datalist id="reasons_list">
                                    <t t-foreach="reasons" t-as="reason" t-key="reason.id">
                                        <t t-if="reason.attendance_state != employee.attendance_state or reason.attendance_state == False">
                                            <option t-att-value="reason.name"/>                     
                                        </t>
                                    </t>
                                </datalist>
                            </div>
                        </div>

                        <!-- 🌍 CONTROL DE GEOLOCALIZACIÓN -->
                        <div t-attf-class="glocation_container mb8 {{ this.state.show_geolocation ? '' : 'd-none' }}" id="glocation_container" t-ref="glocation_container">
                            <i t-attf-class="fa fa-1x fa-angle-double-down glocation_toggle" id="glocation_toggle" t-on-click="onToggleGeolocation" t-ref="glocation_toggle">
                                Geo Location
                            </i>
                            <div t-attf-class="glocation_view d-none" t-ref="glocation_view" >
                                <span>Lattitude:  <t t-esc="state.latitude"/></span>
                                <span>, Longitude: <t t-esc="state.longitude"/></span>
                            </div>
                        </div>
                        
                        <!-- 🗺️ CONTROL DE GEOCERCAS -->
                        <div t-attf-class="geofence_container mb8 {{ this.state.show_geofence ? '' : 'd-none' }}" id="geofence_container" t-ref="geofence_container">
                            <i t-attf-class="fa fa-1x fa-angle-double-down geofence_toggle" id="geofence_toggle" t-on-click="onTogglegeofence" t-ref="geofence_toggle">
                                Map Location
                            </i>
                            <div t-attf-class="geofence_view d-none" t-ref="geofence_view"></div>
                        </div>

                        <!-- 🌐 CONTROL DE DIRECCIÓN IP -->
                        <div t-attf-class="geoipaddress_container mb8 {{ this.state.show_ipaddress ? '' : 'd-none' }}" id="geoipaddress_container" t-ref="geoipaddress_container">
                            <i t-attf-class="fa fa-1x fa-angle-double-down geoipaddress_toggle" id="geoipaddress_toggle"  t-on-click="onToggleGeoipaddress" t-ref="geoipaddress_toggle">
                                IP Address (Public)
                            </i>
                            <div t-attf-class="geoipaddress_view d-none" t-ref="geoipaddress_view">
                                <span> IP: <t t-esc="state.ipaddress"/></span>
                            </div>
                        </div>
                    </div>
                </div>
            </t>
        </xpath>
    </t>
</template>
<?xml version="1.0" encoding="UTF-8"?>
<template>
    <t t-inherit="hr_attendance.attendance_menu" t-inherit-mode="extension">
        
        <!-- üéØ PASO 7: Personalizar bot√≥n del systray seg√∫n attendance_status -->
        <xpath expr="//button[i[contains(@class, 'fa-circle')]]" position="replace">
            <button type="button"
                    class="btn btn-sm o_attendance_systray_button o-dropdown dropdown-toggle dropdown"
                    aria-expanded="false">
                
                <!-- üî¥ Pre-work: Sin registro - √≠cono rojo X -->
                <i t-if="this.state.attendance_status === 'pre_work'" 
                   class="fa fa-times-circle text-danger me-1" style="margin-top: 1px;"/>
                
                <!-- üü° In-work: En jornada - √≠cono amarillo play -->
                <i t-if="this.state.attendance_status === 'in_work'" 
                   class="fa fa-play-circle text-warning me-1" style="margin-top: 1px;"/>
                
                <!-- üü¢ Post-work: Completado - √≠cono verde check -->
                <i t-if="this.state.attendance_status === 'post_work'" 
                   class="fa fa-check-circle text-success me-1" style="margin-top: 1px;"/>
                
                <!-- üîò Fallback: Estado desconocido - √≠cono original -->
                <i t-if="!this.state.attendance_status" 
                   class="fa fa-circle-o me-1"/>
                
                Asistencia
            </button>
        </xpath>
        
        <!-- üîß AGREGAR EVENTO onOpened AL DROPDOWN -->
        <xpath expr="//Dropdown" position="attributes">
            <attribute name="onOpened.bind">onOpenedContent</attribute>
        </xpath>
        
        <!-- üîÑ REEMPLAZAR COMPLETAMENTE EL CONTENIDO DEL SLOT -->
        <xpath expr="//t[@t-set-slot='content']" position="replace">
            <t t-set-slot="content">
                <!-- üîÑ SPINNER DE CARGA -->
                <div t-if="this.state.show_check_inout_button === false" class="o_att_menu_container_spinner text-center">
                    <i class="fa fa-circle-o-notch fa-spin spinner"></i>
                </div>
                
                <!-- üéØ PASO 8: CONTENIDO BASADO EN ATTENDANCE_STATUS -->
                <div t-if="this.state.show_check_inout_button" class="o_att_menu_container d-flex flex-column gap-3">
                    
                    <!-- üåÖ VISTA PRE_WORK: Antes del primer check-in -->
                    <div t-if="this.state.attendance_status === 'pre_work'"
                         class="p-3 mb-3 rounded bg-light border">
                        <h5 class="mb-2 text-primary">
                            ¬°Bienvenido! üëã
                        </h5>
                        <p class="mb-3 text-muted">
                            Todav√≠a no has iniciado tu jornada laboral.  
                            Pulsa el bot√≥n para iniciar tu <strong>jornada</strong> üòâ
                        </p>

                        <div t-attf-class="geofence_container mb8 {{ this.state.show_geofence ? '' : 'd-none' }}" id="geofence_container" t-ref="geofence_container">
                            <i t-attf-class="fa fa-1x fa-angle-double-down geofence_toggle" id="geofence_toggle" t-on-click="onTogglegeofence" t-ref="geofence_toggle">
                                Map Location
                            </i>
                            <div t-attf-class="geofence_view d-none" t-ref="geofence_view"></div>
                        </div>

                        <button t-on-click="() => this.signInOut()"
                                class="btn btn-success w-100">
                            <i class="fa fa-sign-in me-2"/> 
                            Iniciar Jornada
                        </button>
                    </div>

                    <!-- üü° VISTA IN_WORK: Jornada en curso -->
                    <div t-if="this.state.attendance_status === 'in_work'"
                         class="p-3 mb-3 rounded border border-warning">
                        <h5 class="mb-2 text-warning">
                            üü° Jornada en curso
                        </h5>
                        <p class="mb-3 text-muted">
                            ¬°Ya has registrado tu entrada hoy! Tu jornada est√° activa.
                        </p>

                        <!-- üåê INFORMACI√ìN DE RED -->
                        <div t-if="this.state.ipaddress" class="mb-3 p-2 bg-light rounded text-center">
                            <small class="text-muted">üåê Direcci√≥n IP:</small>
                            <div class="fw-bold text-dark" t-esc="this.state.ipaddress"/>
                        </div>

                        <button t-on-click="() => this.signInOut()"
                                class="btn btn-danger w-100">
                            <i class="fa fa-sign-out me-2"/> 
                            Finalizar Jornada
                        </button>
                    </div>
                    
                </div>
            </t>
        </xpath>
    </t>
</template>
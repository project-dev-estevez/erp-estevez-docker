<?xml version="1.0" encoding="UTF-8"?>
<template>
    <t t-inherit="hr_attendance.attendance_menu" t-inherit-mode="extension">
        
        <!-- 🎯 PASO 7: Personalizar botón del systray según attendance_status -->
        <xpath expr="//button[i[contains(@class, 'fa-circle')]]" position="replace">
            <button type="button"
                    class="btn btn-sm o_attendance_systray_button o-dropdown dropdown-toggle dropdown"
                    aria-expanded="false">
                
                <!-- 🔴 Pre-work: Sin registro - ícono rojo X -->
                <i t-if="this.state.attendance_status === 'pre_work'" 
                   class="fa fa-times-circle text-danger me-1" style="margin-top: 1px;"/>
                
                <!-- 🟡 In-work: En jornada - ícono amarillo play -->
                <i t-if="this.state.attendance_status === 'in_work'" 
                   class="fa fa-play-circle text-warning me-1" style="margin-top: 1px;"/>
                
                <!-- 🟢 Post-work: Completado - ícono verde check -->
                <i t-if="this.state.attendance_status === 'post_work'" 
                   class="fa fa-check-circle text-success me-1" style="margin-top: 1px;"/>
                
                <!-- 🔘 Fallback: Estado desconocido - ícono original -->
                <i t-if="!this.state.attendance_status" 
                   class="fa fa-circle-o me-1"/>
                
                Asistencia
            </button>
        </xpath>
        
        <!-- 🔧 AGREGAR EVENTO onOpened AL DROPDOWN -->
        <xpath expr="//Dropdown" position="attributes">
            <attribute name="onOpened.bind">onOpenedContent</attribute>
        </xpath>
        
        <!-- 🔄 REEMPLAZAR COMPLETAMENTE EL CONTENIDO DEL SLOT -->
        <xpath expr="//t[@t-set-slot='content']" position="replace">
            <t t-set-slot="content">
                <!-- 🔄 SPINNER DE CARGA -->
                <div t-if="this.state.show_check_inout_button === false" class="o_att_menu_container_spinner text-center">
                    <i class="fa fa-circle-o-notch fa-spin spinner"></i>
                </div>
                
                <!-- 🎯 PASO 8: CONTENIDO BASADO EN ATTENDANCE_STATUS -->
                <div t-if="this.state.show_check_inout_button" class="o_att_menu_container d-flex flex-column gap-3">
                    
                    <!-- 🌅 VISTA PRE_WORK: Antes del primer check-in -->
                    <div t-if="this.state.attendance_status === 'pre_work'"
                         class="p-3 mb-3 rounded bg-light border">
                        <h5 class="mb-2 text-primary">
                            ¡Bienvenido! 👋
                        </h5>
                        <p class="mb-3 text-muted">
                            Todavía no has iniciado tu jornada laboral.  
                            Pulsa el botón para iniciar tu <strong>jornada</strong> 😉
                        </p>

                        <div t-attf-class="geofence_container mb8 {{ this.state.show_geofence ? '' : 'd-none' }}" id="geofence_container" t-ref="geofence_container">
                            <i t-attf-class="fa fa-1x fa-angle-double-down geofence_toggle" id="geofence_toggle" t-on-click="onTogglegeofence" t-ref="geofence_toggle">
                                Map Location
                            </i>
                            <div t-attf-class="geofence_view d-none" t-ref="geofence_view"></div>
                        </div>

                        <button t-on-click="() => this.signInOut()"
                                class="btn btn-success w-100">
                            <i class="fa fa-sign-in me-2"/> 
                            Iniciar Jornada
                        </button>
                    </div>

                    <!-- 🟡 VISTA IN_WORK: Jornada en curso -->
                    <div t-if="this.state.attendance_status === 'in_work'"
                         class="p-3 mb-3 rounded border border-warning">
                        <h5 class="mb-2 text-warning">
                            🟡 Jornada en curso
                        </h5>
                        <p class="mb-3 text-muted">
                            ¡Ya has registrado tu entrada hoy! Tu jornada está activa.
                        </p>

                        <!-- 🗺️ INFORMACIÓN DE GEOCERCAS -->
                        <div t-if="this.state.geofences and this.state.geofences.length" class="mb-3 p-2 bg-light rounded text-center">
                            <small>🗺️ Ubicaciones Permitidas:</small>
                            <ul class="list-unstyled">
                                <t t-foreach="this.state.geofences" t-as="geofence" t-key="geofence.id">
                                    <li class="fw-bold text-dark">
                                        <span t-esc="geofence.name"/>
                                        <span t-if="geofence.description" class="text-muted"> - <t t-esc="geofence.description"/></span>
                                    </li>
                                </t>
                            </ul>
                            <small t-if="this.state.ipaddress" class="text-muted">IP: <t t-esc="this.state.ipaddress"/> </small>
                        </div>

                        <button t-on-click="() => this.signInOut()"
                                class="btn btn-danger w-100">
                            <i class="fa fa-sign-out me-2"/> 
                            Finalizar Jornada
                        </button>
                    </div>

                    <!-- 🟢 VISTA POST_WORK: Jornada completada -->
                    <div t-if="this.state.attendance_status === 'post_work'"
                         class="p-3 mb-3 rounded border border-success bg-light">
                        <h5 class="mb-2 text-success text-center">
                            🎉 ¡Jornada Completada!
                        </h5>
                        <p class="mb-3 text-center text-muted">
                            Has completado exitosamente tu jornada laboral de hoy. <br/>
                            <strong>¡Excelente trabajo!</strong> 💪
                        </p>

                        <!-- 💬 MENSAJE MOTIVACIONAL -->
                        <div class="alert alert-success text-center mb-3">
                            <strong>¡Nos vemos!</strong><br/>
                            <small>Que tengas un excelente resto del día 😊</small>
                        </div>

                        <!-- 🔄 BOTÓN DE NUEVA JORNADA (opcional, para casos especiales) -->
                        <div class="text-center">
                            <small class="text-muted">
                                <i class="fa fa-info-circle me-1"/>
                                Si necesitas registrar una nueva entrada, contacta a tu supervisor
                            </small>
                        </div>
                    </div>
                    
                </div>
            </t>
        </xpath>
    </t>
</template>
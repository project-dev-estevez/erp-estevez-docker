<?xml version="1.0" encoding="UTF-8"?>
<template>

    <t t-name="attendance_face_recognition.AttendanceRecognitionDialog" id="AttendanceRecognitionDialog">
        <Dialog size="'md'" fullscreen="true" title="'Reconocimiento Facial'">
            <t t-set-slot="header">
                <div class="d-flex w-100">
                    <h4>Reconocimiento Facial</h4>
                    <div t-on-click="onClose" type="button" class="btn-close" aria-label="Close"/>
                </div>
            </t>
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12 controls">
                        <fieldset class="border rounded p-3 bg-light">
                            <div class="row align-items-center">
                                <div class="col-md-4 text-md-end mb-2 mb-md-0">
                                    <label class="form-label fw-semibold">
                                        <span>Seleccionar CÃ¡mara</span>
                                    </label>
                                </div>
                                <div class="col-md-6">
                                    <select name="video_source" class="form-select videoSource" id="videoSource" t-ref="select"></select>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                </div>
                <!-- Mensaje de instrucciÃ³n y contador de parpadeos -->
                <div class="row mb-3">
                    <div class="col-12 text-center">
                        <div t-if="!state.waitingForOpenEyes" class="alert alert-info d-inline-block px-4 py-2 mb-2" role="alert">
                            Por favor, parpadea <b>3 veces</b> para validar tu identidad.
                        </div>
                        <!-- ðŸŽ¯ Mensaje de espera despuÃ©s del tercer parpadeo -->
                        <div t-if="state.waitingForOpenEyes" class="alert alert-success d-inline-block px-4 py-3 mb-2" role="alert">
                            <div class="d-flex align-items-center justify-content-center gap-2">
                                <div class="spinner-border spinner-border-sm text-success" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <strong>Â¡MantÃ©n los ojos abiertos!</strong> Preparando captura...
                            </div>
                        </div>
                        <div class="fs-5 fw-bold text-primary">
                            Parpadeos detectados: <span t-esc="state.blinkCount || 0"/> / 3
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 mt8" id="videoContainer" t-ref="videoContainer" style="display: table;position: relative;">
                        <video id="video" style="width: 100%; max-height: 100%; box-sizing: border-box;" muted="true" autoplay="false" playsinline="true" t-ref="video"/>  
                        <canvas id="canvas" style="position: absolute; top: 0;  bottom: 0;  display: block; " t-ref="canvas"/>
                        <canvas id="image" style="display: none;" t-ref="image"/>
                        
                        <!-- ðŸŽ¯ Overlay de espera despuÃ©s del tercer parpadeo -->
                        <div t-if="state.waitingForOpenEyes" 
                             style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
                                    background: rgba(40, 167, 69, 0.2); 
                                    display: flex; align-items: center; justify-content: center;
                                    backdrop-filter: blur(2px);">
                            <div class="text-center p-4 bg-white rounded-3 shadow-lg border border-success" style="max-width: 400px;">
                                <div class="spinner-border text-success mb-3" style="width: 3rem; height: 3rem;" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <h5 class="text-success fw-bold mb-2">
                                    <i class="fa fa-eye me-2"/>Â¡MantÃ©n los ojos abiertos!
                                </h5>
                                <p class="text-muted mb-0">Preparando la captura de tu rostro...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
             <t t-set-slot="footer">
                <button class="btn btn-secondary" t-on-click="props.close">Cancelar</button>
            </t>
        </Dialog>
    </t>

</template>
